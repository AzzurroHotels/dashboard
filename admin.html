<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” User Management</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:#f1f5f9;padding:28px;color:#0F172A}
        h1{font-size:26px;font-weight:700;margin-bottom:4px}
        .sub{color:#64748B;font-size:14px;margin-bottom:24px}
        .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
        .stat{background:#fff;border-radius:14px;padding:18px 20px;border:1px solid #e2e8f0}
        .stat-label{font-size:11px;font-weight:600;color:#64748B;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
        .stat-val{font-size:28px;font-weight:700}
        .card{background:#fff;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden}
        .card-hdr{padding:18px 24px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}
        .card-hdr h2{font-size:16px;font-weight:700}
        .user-row{padding:14px 24px;display:flex;align-items:center;gap:14px;border-bottom:1px solid #f8fafc;cursor:pointer;transition:.15s}
        .user-row:hover{background:#f8fafc}
        .user-row.expanded{background:rgba(196,168,119,.04)}
        .avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#C4A877,#E8D5B0);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#0F172A;flex-shrink:0}
        .user-info{flex:1}
        .user-name{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
        .user-email{font-size:12px;color:#64748B}
        .badge{font-size:10px;font-weight:600;padding:3px 10px;border-radius:8px;text-transform:capitalize}
        .b-admin{background:#C4A87720;color:#C4A877}.b-manager{background:#3B82F620;color:#3B82F6}.b-receptionist{background:#16A34A20;color:#16A34A}.b-staff{background:#94A3B820;color:#94A3B8}
        .badge-you{font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(22,163,74,.1);color:#16A34A}
        .access-count{font-size:11px;font-weight:500;width:100px;text-align:right}
        .a-yes{color:#16A34A}.a-no{color:#EF4444}
        .arrow{font-size:12px;color:#94A3B8;transition:transform .2s}
        .arrow.open{transform:rotate(180deg)}
        .detail{padding:0 24px 20px;background:rgba(196,168,119,.02);display:none}
        .detail.open{display:block}
        .detail-section{font-size:11px;font-weight:600;color:#64748B;text-transform:uppercase;letter-spacing:.5px;margin:12px 0 8px}
        .role-btns{display:flex;gap:6px;flex-wrap:wrap}
        .role-btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;text-transform:capitalize;border:1.5px solid rgba(0,0,0,.06);background:rgba(0,0,0,.03);color:#94A3B8;transition:.2s;font-family:inherit}
        .role-btn.active{border-color:currentColor}
        .role-btn:disabled{opacity:.5;cursor:not-allowed}
        .dash-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .dash-card{padding:14px 12px;border-radius:12px;cursor:pointer;text-align:center;border:2px solid rgba(0,0,0,.06);background:rgba(0,0,0,.02);transition:.2s}
        .dash-card.on{border-color:#16A34A;background:rgba(22,163,74,.08)}
        .dash-card-icon{font-size:22px;margin-bottom:4px}
        .dash-card-name{font-size:12px;font-weight:600}
        .dash-card-desc{font-size:10px;color:#64748B;margin-top:2px}
        .dash-card-status{margin-top:8px;font-size:10px;font-weight:700;padding:3px 10px;border-radius:6px;display:inline-block}
        .dash-card.on .dash-card-status{color:#16A34A;background:rgba(22,163,74,.1)}
        .dash-card:not(.on) .dash-card-status{color:#94A3B8;background:rgba(0,0,0,.03)}
        .btn-danger{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:rgba(239,68,68,.08);border:1.5px solid rgba(239,68,68,.2);color:#EF4444;font-family:inherit}
        .actions{display:flex;justify-content:space-between;align-items:start;padding-top:8px;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .loading{text-align:center;padding:60px;color:#94A3B8;font-size:14px}
    </style>
</head>
<body>

<h1>User Management</h1>
<p class="sub">Manage staff accounts and dashboard access permissions</p>
<div class="stats" id="stats"></div>
<div class="card">
    <div class="card-hdr"><h2>All Staff</h2><span id="userCount" style="font-size:12px;color:#64748B"></span></div>
    <div id="userList"><div class="loading">Loading users...</div></div>
</div>

<script type="module">
import { supabase } from './supabase-config.js';

const DASHES = [
    { id:'maintenance', label:'Maintenance', icon:'ðŸ”§', desc:'Property issues & repairs' },
    { id:'hr', label:'HR Dashboard', icon:'ðŸ‘¥', desc:'Team tasks & management' },
    { id:'complaints', label:'Complaints', icon:'ðŸ“‹', desc:'Guest complaint tracking' },
];

let users = [], accessMap = {}, myId = null, expanded = null;

async function init() {
    const { data:{ user } } = await supabase.auth.getUser();
    if (!user) return;
    myId = user.id;
    await load();
    render();

    supabase.channel('admin-rt')
        .on('postgres_changes', { event:'*', schema:'public', table:'profiles' }, () => load().then(render))
        .on('postgres_changes', { event:'*', schema:'public', table:'dashboard_access' }, () => load().then(render))
        .subscribe();
}

async function load() {
    const { data:profiles } = await supabase.from('profiles').select('*').order('created_at');
    users = profiles || [];
    const { data:access } = await supabase.from('dashboard_access').select('*');
    accessMap = {};
    (access || []).forEach(a => { if (!accessMap[a.user_id]) accessMap[a.user_id] = []; accessMap[a.user_id].push(a.dashboard); });
}

function render() {
    const noAccess = users.filter(u => !(accessMap[u.id]||[]).length && u.role !== 'admin').length;
    document.getElementById('stats').innerHTML = [
        { l:'Total Users', v:users.length, c:'#0891b2' },
        { l:'Admins', v:users.filter(u=>u.role==='admin').length, c:'#C4A877' },
        { l:'Managers', v:users.filter(u=>u.role==='manager').length, c:'#3B82F6' },
        { l:'No Access', v:noAccess, c:'#EF4444' },
    ].map(s => `<div class="stat"><div class="stat-label">${s.l}</div><div class="stat-val" style="color:${s.c}">${s.v}</div></div>`).join('');

    document.getElementById('userCount').textContent = users.length + ' members';
    const list = document.getElementById('userList');
    list.innerHTML = users.map(u => {
        const fullName = (u.full_name || u.email || 'User');
        const initials = String(fullName).trim().split(/\s+/).filter(Boolean).slice(0,2).map(n=>n[0]).join('').toUpperCase() || '?';
        const isMe = u.id === myId, isExp = expanded === u.id;
        const dashes = accessMap[u.id] || [], ac = dashes.length;
        const rc = { admin:'b-admin', manager:'b-manager', receptionist:'b-receptionist', staff:'b-staff' };
        const roleColors = { admin:'#C4A877', manager:'#3B82F6', receptionist:'#16A34A', staff:'#94A3B8' };

        return `
        <div class="user-row ${isExp?'expanded':''}" onclick="toggle('${u.id}')">
            <div class="avatar">${initials}</div>
            <div class="user-info">
                <div class="user-name">${fullName} ${isMe?'<span class="badge-you">You</span>':''}</div>
                <div class="user-email">${u.email}</div>
            </div>
            <span class="badge ${rc[u.role]||'b-staff'}">${u.role}</span>
            <span class="access-count ${ac>0?'a-yes':'a-no'}">${ac>0?ac+' dashboard'+(ac>1?'s':''):'No access'}</span>
            <span class="arrow ${isExp?'open':''}">â–¼</span>
        </div>
        ${isExp?`<div class="detail open">
            <div class="actions">
                <div>
                    <div class="detail-section">Role</div>
                    <div class="role-btns">
                        ${['receptionist','manager','admin','staff'].map(r => `
                            <button class="role-btn ${u.role===r?'active':''}" 
                                style="${u.role===r?'border-color:'+roleColors[r]+';color:'+roleColors[r]:''}"
                                onclick="event.stopPropagation();setRole('${u.id}','${r}')" ${isMe?'disabled':''}>${r}</button>
                        `).join('')}
                    </div>
                </div>
                ${!isMe?`<button class="btn-danger" onclick="event.stopPropagation();removeUser('${u.id}')" style="margin-top:24px">Remove User</button>`:''}
            </div>
            <div class="detail-section">Dashboard Access</div>
            <div class="dash-grid">
                ${DASHES.map(d => {
                    const has = dashes.includes(d.id);
                    return `<div class="dash-card ${has?'on':''}" onclick="event.stopPropagation();toggleDash('${u.id}','${d.id}')">
                        <div class="dash-card-icon">${d.icon}</div>
                        <div class="dash-card-name">${d.label}</div>
                        <div class="dash-card-desc">${d.desc}</div>
                        <div class="dash-card-status">${has?'âœ“ Enabled':'Disabled'}</div>
                    </div>`;
                }).join('')}
            </div>
        </div>`:''}`;
    }).join('');
}

window.toggle = function(uid) { expanded = expanded === uid ? null : uid; render(); };

window.setRole = async function(uid, role) {
    await supabase.from('profiles').update({ role }).eq('id', uid);
    await load(); render();
};

window.toggleDash = async function(uid, dashId) {
    const has = (accessMap[uid] || []).includes(dashId);
    if (has) await supabase.from('dashboard_access').delete().eq('user_id', uid).eq('dashboard', dashId);
    else await supabase.from('dashboard_access').insert({ user_id: uid, dashboard: dashId, granted_by: myId });
    await load(); render();
};

window.removeUser = async function(uid) {
    if (!confirm('Remove this user? This cannot be undone.')) return;
    await supabase.from('dashboard_access').delete().eq('user_id', uid);
    await supabase.from('profiles').delete().eq('id', uid);
    await load(); render();
};

init();
</script>
</body>
</html>
